---
title: "Analyte_Event_Date_Table"
output: html_document
date: "2025-05-15"
---

```{r, label='libraries', echo= FALSE}
library(shiny)
library(AWQMSdata)
library(dplyr)
library(readxl)
library(openxlsx)
library(shinybusy)
library(rmarkdown)
library(tidyverse)
library(DT)
library(lubridate)
```

```{r, identify the data you want}
library(shiny)
library(AWQMSdata)
library(dplyr)
library(readxl)
library(openxlsx)
library(shinybusy)
library(rmarkdown)
library(tidyverse)
library(DT)
library(lubridate)

local_path ="C:/Users/cthomas/Downloads/"

#Data Location To Import (must already be in AWQMS format)
Contingency_Data_Location <- "C:/Users/cthomas/Downloads/kfalls-tox-prelim_EDD_Data_Check_2025-09-30.xlsx"


#Define Monitoring Location & Organization
station = "20226-ORDEQ"
org = "CITY_KLAMATHFALLS"


#Preferred Export File Name
Excel_Write_Path = paste(local_path, station, "_", org, "Contingency_Table.xlsx")

# FIGURE OUT HOW TO REMOVE SPACES IN THE PATH ABOVE

```


```{r, import the data you want and then export a contigency table}
#read in raw data 
Raw_Contingency_Data <- read_excel(Contingency_Data_Location) 

Filtered_Contingency_Data <- Raw_Contingency_Data %>% filter(MLocID == station) 

#combine Char_Name and Sample_Fraction to separate dissolved vs total
Filtered_Contingency_Data <- Filtered_Contingency_Data %>% 
  mutate(Char_and_Fraction = paste(Char_Name,Sample_Fraction, sep = ", "))

# YOU COULD IMPROVE ABOVE BY EXCLUDING NAs from the naming convention!


#this table code actually does all the work
table_data <- table(Filtered_Contingency_Data$Char_and_Fraction, Filtered_Contingency_Data$SampleStartDate)
print_table_data <- print(table_data)

#this is currently unused, but a useful starting point to add features
data_frame_convert <- as.data.frame(table_data)

#writes the excel file to review
write.xlsx(table_data, Excel_Write_Path)

```

#list of unique characteristics and dates (unused I think)
unique_characteristics <- Raw_Contingency_Data %>% select(Char_Name) %>% unique()
unique_dates <- Raw_Contingency_Data %>% select(SampleStartDate) %>% unique()





```




```{r combine into one df}
# Load necessary libraries
library(readxl)
library(openxlsx)
library(tidyverse)

In <- "C:/Users/cthomas/Documents_local/local_workspace/Cascade_Steel_local/Toxics/OF-001_Toxics_Resubmit/Cascade_Steel_Summary"
Out <-"C:/Users/cthomas/Documents_local/local_workspace/Cascade_Steel_local/Toxics/OF-001_Toxics_Resubmit/OF-002-combined_in_R_for_QC.xlsx"


# Define the folder path containing the .xlsx files
folder_path <- In

# Get a list of all .xlsx files in the folder
file_list <- list.files(path = folder_path, pattern = "\\.xlsx$", full.names = TRUE)

# Initialize an empty list to store data frames
data_list <- list()

#convert date/time to character
data_list|>
  map_dfr(~mutate(across(everything(), as.character))) |>
  type.convert()

# Loop through each file and read the "Results" tab
for (file in file_list) {
  # Read the "Results" sheet
  data <- read_excel(file, sheet = "Results")
  
  # Add the data frame to the list
  data_list[[file]] <- data
}

character_dataset <- lapply(data_list,function(a) { a  %>% 
    mutate(across(1:27, as.character))})

# Combine all data frames into one
combined_data <- bind_rows(character_dataset)

data4 <- select(combined_data,1:24)

#Remove NAs
data5 <- data4[rowSums(is.na(combined_data)) != ncol(combined_data),] 

write.xlsx(data5, Out)

table(data5$'Analyte Name')
table <-as.data.frame(table(data5$'Analyte Name'))


```


```{r}
#data6 <- read_excel("")



#use this
table(data6$'Analyte Name')

#use this once just for example
#table(data6$'Phenol')
```


```{r} 
sample1path <- "C:/Users/cthomas/Documents_local/local_workspace/Cascade_Steel_local/Toxics/OF-001_Toxics_Resubmit/R/4AWQMS_20230215_001_CascadeSteelSampleSubmission_Toxics_EDD_V_1_6_2020.xlsx"
sample2path <- "C:/Users/cthomas/Documents_local/local_workspace/Cascade_Steel_local/Toxics/OF-001_Toxics_Resubmit/R/4AWQMS_20240228_001_22824_CascadeSteelSampleSubmission_Toxics_EDD_V_1_6_2020.xlsx"
full_first <- read_excel(sample1path, sheet = "Results")
full_second <- read_excel(sample2path, sheet = "Results")

sample1 <- data.frame(unique(full_first$'Analyte Name'))
colnames(sample1)[1] <- "Analyte_Name"
sample2 <- data.frame(unique(full_second$'Analyte Name'))
colnames(sample2)[1] <- "Analyte_Name"
#sample3 <- data.frame(unique(data6$'Phenol'))

anti_join <- anti_join(sample1,sample2, by = "Analyte_Name")

```


